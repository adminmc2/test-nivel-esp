// ✅ LAS 40 PREGUNTAS DEL TEST DE ESPAÑOL CORREGIDAS
const testQuestions = [
    { id: 1, question: "Hola, ¿de dónde _____ vosotros?", options: ["eres", "soys", "sois", "soy"], correct: 2 },
    { id: 2, question: "La escuela _____ muy bonita y _____ en la playa.", options: ["está -- es", "es -- está", "es - es", "está -- está"], correct: 1 },
    { id: 3, question: "¿Dónde _____? -Yo _____ en Málaga.", options: ["vives -- vivo", "vivís - vivimos", "trabajo -- trabajas", "comemos -- comes"], correct: 0 },
    { id: 4, question: "¿_____ puedo comprar un buen vino? -En _____ tienda cerca de la escuela.", options: ["Cuándo -- su", "Por qué -- mi", "Cómo -- una", "Dónde -- la"], correct: 3 },
    { id: 5, question: "En Andalucía, (ella) _____ _____ siempre las gafas de sol.", options: ["se desayuna", "se pone", "se lava", "os preparamos"], correct: 1 },
    { id: 6, question: "¿_____ profesores dan clase hoy?", options: ["Quienes", "Qué", "Que", "Quién"], correct: 1 },
    { id: 7, question: "_____ casa es _____ casa.", options: ["Mi -- nuestras", "Su - sus", "Vuestra -- tus", "Mi -- tu"], correct: 3 },
    { id: 8, question: "Vienes a una escuela _____ bonita en la que se trabaja _____ y _____ bien.", options: ["muy - mucho - mucho", "mucha - muy - muy", "muy - mucho - muy", "muy - mucho -- mucha"], correct: 2 },
    { id: 9, question: "A mí _____ _____ mucho ir en bicicleta, pero a mi compañero no _____ _____ nada.", options: ["nos gustan - le gusta", "les gusta - te gusta", "me gusta - le gusta", "me gustan - les gustan"], correct: 2 },
    // ✅ PREGUNTA 10 CORREGIDA: Mayúsculas en las opciones
    { id: 10, question: "Esta escuela es la mejor. Me gusta mucho. _____ _____ recomiendo.", options: ["Te - la", "La - tu", "Le - ta", "Me - La"], correct: 0 },
    { id: 11, question: "En la clase siempre me _____ cerca de la profesora.", options: ["duermo", "acuesto", "siento", "desayuno"], correct: 2 },
    { id: 12, question: "Mi padre mide 2 metros. Es el _____ _____ de sus hermanos.", options: ["mayor", "más alto", "altísimo", "muy alto"], correct: 1 },
    { id: 13, question: "Son las diez y dos minutos de la mañana. La primera clase _____ _____ empezar ahora mismo.", options: ["termina - de", "debe", "vuelve - a", "acaba -- de"], correct: 3 },
    { id: 14, question: "Mi español _____ antes muy básico, pero ahora puedo comunicarme mucho mejor.", options: ["fue", "era", "estuvo", "estaba"], correct: 2 },
    { id: 15, question: "¿_____ ayer a la excursión a Granada?", options: ["fuiste", "estuviste", "eras", "estabas"], correct: 0 },
    { id: 16, question: "He venido a esta escuela _____ mejorar mi español.", options: ["por", "al", "para", "así puedo"], correct: 2 },
    { id: 17, question: "No me apetece seguir leyendo la revista. _____ tú.", options: ["Resérvala", "Límpiala", "Cómprala", "Léela"], correct: 3 },
    { id: 18, question: "Anoche _____ sangría en la playa y esta mañana nos _____ _____ tarde.", options: ["nos gustaba - hemos escuchado", "comimos - te gusta", "bebimos - hemos levantado", "me gustan - les gustan"], correct: 2 },
    { id: 19, question: "No sé qué edad tiene. _____ tener sobre cuarenta años.", options: ["quiere", "acaba de", "empieza a", "debe"], correct: 3 },
    { id: 20, question: "Señora, _____ que le ayude.", options: ["déjame", "permíteme", "permítame", "quieres"], correct: 2 },
    { id: 21, question: "¿De verdad? -Te lo _____. _____ caso.", options: ["promeso / tenme", "juro / hazme", "aseguro / dame", "garantizo / concédeme"], correct: 1 },
    { id: 22, question: "Me parece que no _____ interés por visitar la feria mañana.", options: ["tengo", "tenga", "tuve", "tenía"], correct: 0 },
    { id: 23, question: "No creo que _____ problemas en pasarse por aquí después.", options: ["tengo", "tenga", "tendrá", "teniera"], correct: 1 },
    { id: 24, question: "La gran _____ está de acuerdo en hacer la fiesta el viernes por la noche.", options: ["mayoridad", "minoría", "mayoría", "totalidad"], correct: 2 },
    { id: 25, question: "No me _____ bien de lo que _____ después.", options: ["acuerdo / pasando", "recuerdo / pasó", "acuerdo / pasó", "recuerdo / pasaba"], correct: 2 },
    { id: 26, question: "Espero que te _____ mejor cuando por fin te _____. Hoy has caminado mucho y te mereces un buen descanso.", options: ["sientes / sientas", "sientas / sientas", "sientes / sientes", "sientas / sientes"], correct: 3 },
    { id: 27, question: "Cuando estaba _____ a casa, _____ el atardecer tras las montañas.", options: ["moviendo / miraba", "avanzando / vi", "yendo / vi", "marchando / veí"], correct: 2 },
    { id: 28, question: "Este fin de semana queremos _____ con Pepe y Sara.", options: ["encontrar", "ver", "quedar", "marchar"], correct: 2 },
    { id: 29, question: "!_____! ¡Te he dicho que te sientes!", options: ["Siéntese", "Siéntense", "Siéntate", "Sentaos"], correct: 2 },
    { id: 30, question: "_____ _____ gustado conocer Frigiliana. Pero en sólo dos días por Málaga, ¡no _____ tiempo de visitarla! La próxima vez _____.", options: ["Nos hubiera / tendríamos / iremos", "Nos habría / tuvimos / iremos", "Nos hubiese / tendremos / vamos", "Nos fuera / hemos tenido / iríamos"], correct: 1 },
    { id: 31, question: "No sabíamos que ya _____ a la cama. Si lo _____ _____, no habríamos hecho tanto ruido.", options: ["se habíais / fuéramos sabido", "te ibas / hemos sabido", "os habíais ido / hubiéramos sabido", "había"], correct: 2 },
    { id: 32, question: "Ojalá que no _____ _____ con nosotros. Cada vez que _____ hay problemas.", options: ["se vaya / vino", "se venga / fue", "se venga / viene", "se vaya / va"], correct: 2 },
    { id: 33, question: "Si te _____ un trabajo como ese, yo que tú no me lo _____. ¡Es una suerte increíble!", options: ["ofrecían / pensé", "ofrecen / pensaba", "ofrecieran / pensaré", "hubieran ofrecido / pensabas"], correct: 1 },
    { id: 34, question: "En la entrevista se reprodujeron al pie de la letra las palabras del entrevistado.", options: ["las palabras se reprodujeron a pie de página", "las palabras se reprodujeron sin exactitud", "las palabras se reprodujeron literalmente", "las palabras se reprodujeron en letras grandes"], correct: 2 },
    { id: 35, question: "En cuanto _____ a qué hora es el concierto, _____ de casa.", options: ["sabemos / salimos", "supimos / salíamos", "sepamos / saldremos", "sabremos / saldríamos"], correct: 2 },
    { id: 36, question: "Hizo la actividad _____ le dijo el profesor que la hiciera.", options: ["tal como", "igual como", "lo mismo como", "tal y cual"], correct: 0 },
    { id: 37, question: "_____ y _____ el texto definitivo cuando lo tengas listo.", options: ["Piénselo / dime", "Piénsatelo / dígame", "Piénsatelo / dime", "Piénseselo / dígamelo"], correct: 2 },
    { id: 38, question: "Siempre que viene tu sobrina se pone a 'dar la lata' al perro.", options: ["animar", "alimentar", "molestar", "jugar con"], correct: 2 },
    { id: 39, question: "¿_____ se han apuntado a la excursión a Tarifa? Pues no sé, _____ _____ apuntado unos siete alumnos.", options: ["quiénes / os hayáis", "cuántos / se habrán", "cuáles / se hayan", "cómo / me habrán"], correct: 1 },
    { id: 40, question: "Mi hermano _____ es el _____ vendedor que he conocido nunca.", options: ["mejor / meyor", "mayor / major", "mayor / mejor", "major / meyor"], correct: 2 }
];

// ✅ BAREMO CORREGIDO PARA ESPAÑOL (según documento oficial)
const getLevel = (correctAnswers) => {
    if (correctAnswers >= 0 && correctAnswers <= 9) return "A1";
    if (correctAnswers >= 10 && correctAnswers <= 19) return "A2";
    if (correctAnswers >= 20 && correctAnswers <= 29) return "B1";
    if (correctAnswers >= 30 && correctAnswers <= 40) return "B2";
    return "A1";
};

// ✅ FUNCIÓN submitToAirtable EXACTA DEL CÓDIGO DE INGLÉS (solo campos adaptados para español)
const submitToAirtable = async () => {
    setLoading(true);
    
    console.log('═══════════════════════════════════════════════════════════════');
    console.log('🚀 [INICIO] Proceso de envío a Airtable');
    console.log('═══════════════════════════════════════════════════════════════');
    
    try {
        // PASO 1: Cálculos y validaciones
        console.log('📊 [PASO 1] Calculando puntuación...');
        const score = calculateScore();
        const level = getLevel(score.correct);
        console.log('✅ [PASO 1] Puntuación calculada:', score);
        console.log('✅ [PASO 1] Nivel determinado:', level);
        
        // PASO 2: Validar datos del estudiante
        console.log('👤 [PASO 2] Validando datos del estudiante...');
        console.log('   - Nombre:', studentData.firstName);
        console.log('   - Apellidos:', studentData.lastName);
        console.log('   - Email:', studentData.email);
        console.log('   - Ciudad:', studentData.city);
        console.log('   - Canal adquisición:', studentData.howFoundUs);
        console.log('   - Propósito:', studentData.learningPurpose);
        console.log('   - Frecuencia:', studentData.frequency);
        console.log('   - Protección datos:', studentData.dataProtection);
        
        // PASO 3: Validar configuración Airtable
        console.log('⚙️ [PASO 3] Validando configuración Airtable...');
        console.log('   - Base ID:', AIRTABLE_CONFIG.baseId);
        console.log('   - Tabla:', AIRTABLE_CONFIG.tableName);
        console.log('   - Token presente:', AIRTABLE_CONFIG.apiToken ? 'SÍ (longitud: ' + AIRTABLE_CONFIG.apiToken.length + ')' : 'NO');
        
        // PASO 4: Preparar datos
        console.log('📦 [PASO 4] Preparando datos para envío...');
        
        // Crear objeto con respuestas detalladas (texto real, no números)
        const detailedAnswers = {};
        testQuestions.forEach(question => {
            if (answers[question.id] !== undefined) {
                detailedAnswers[`Pregunta ${question.id}: ${question.question}`] = 
                    question.options[answers[question.id]];
            }
        });
        
        const dataToSend = {
            records: [{
                fields: {
                    // ✅ Campos EXACTOS del código de inglés, adaptados para español
                    "Nombre del estudiante": studentData.firstName,
                    "Apellidos del estudiante": studentData.lastName,
                    "Email": studentData.email,
                    "Ciudad": studentData.city || "",
                    "Canal de adquisición": studentData.howFoundUs || "",
                    "Propósito": studentData.learningPurpose || "",
                    "Frecuencia de curso": studentData.frequency || "",
                    
                    // ✅ Campos automáticos adaptados para español
                    "Tipo de test de nivel": "Test de nivel español", // 🔄 ADAPTADO
                    "Idioma": "Español", // 🔄 ADAPTADO
                    
                    // ✅ Resultados del test (igual que inglés)
                    "Puntuación": score.correct,
                    "Porcentaje": score.percentage,
                    "Nivel CEFR": level,
                    "Fecha de realización": new Date().toISOString().split('T')[0],
                    "Respuestas detalladas": JSON.stringify(detailedAnswers, null, 2)
                }
            }]
        };
        
        console.log('✅ [PASO 4] Datos preparados:');
        console.log('   - Número de registros:', dataToSend.records.length);
        console.log('   - Número de campos:', Object.keys(dataToSend.records[0].fields).length);
        console.log('   - Campos enviados:', Object.keys(dataToSend.records[0].fields));
        console.log('📋 [PASO 4] JSON completo a enviar:');
        console.log(JSON.stringify(dataToSend, null, 2));
        
        // PASO 5: Preparar request
        console.log('🌐 [PASO 5] Preparando request HTTP...');
        const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
        console.log('   - URL completa:', url);
        console.log('   - Método: POST');
        console.log('   - Content-Type: application/json');
        console.log('   - Authorization: Bearer [TOKEN_PRESENTE]');
        
        // PASO 6: Hacer request
        console.log('📡 [PASO 6] Enviando request a Airtable...');
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSend)
        });
        
        console.log('📥 [PASO 6] Response recibido:');
        console.log('   - Status:', response.status);
        console.log('   - Status Text:', response.statusText);
        console.log('   - OK:', response.ok);
        console.log('   - Headers:', [...response.headers.entries()]);
        
        // PASO 7: Procesar respuesta
        console.log('🔍 [PASO 7] Procesando respuesta...');
        
        if (response.ok) {
            const responseData = await response.json();
            console.log('✅ [ÉXITO] ¡Datos guardados exitosamente!');
            console.log('   - Datos completos de respuesta:', responseData);
            console.log('   - Record ID creado:', responseData.records?.[0]?.id || 'No disponible');
            console.log('   - Timestamp:', new Date().toISOString());
            
            setSubmitted(true);
            setCurrentPage('results');
            
            console.log('🎉 [ÉXITO] Proceso completado - usuario redirigido a resultados');
            
        } else {
            console.log('❌ [ERROR] Response no OK - procesando error...');
            const responseText = await response.text();
            console.log('📄 [ERROR] Response text completo:', responseText);
            
            try {
                const errorData = JSON.parse(responseText);
                console.log('❌ [ERROR] Error JSON parseado:', errorData);
                console.log('   - Tipo de error:', errorData.error?.type);
                console.log('   - Mensaje:', errorData.error?.message);
                console.log('   - Detalles completos:', errorData);
                
                // Mostrar error más detallado
                if (errorData.error && errorData.error.message) {
                    alert(`❌ Error específico de Airtable:\n\nTipo: ${errorData.error.type}\nMensaje: ${errorData.error.message}\n\nRevisa la consola para más detalles.`);
                } else {
                    alert('❌ Error al guardar los datos. Revisa la consola para ver los detalles completos.');
                }
            } catch (parseError) {
                console.log('❌ [ERROR] No se pudo parsear respuesta como JSON:', parseError);
                console.log('📄 [ERROR] Respuesta cruda:', responseText);
                alert(`❌ Error de servidor. Status: ${response.status}\nRevisa la consola para más detalles.`);
            }
        }
    } catch (error) {
        console.log('💥 [ERROR CRÍTICO] Error en try/catch principal:');
        console.log('   - Nombre:', error.name);
        console.log('   - Mensaje:', error.message);
        console.log('   - Stack:', error.stack);
        alert(`💥 Error de conexión crítico:\n${error.message}\n\nRevisa la consola para más detalles.`);
    } finally {
        console.log('🏁 [FINAL] Finalizando proceso...');
        setLoading(false);
        console.log('═══════════════════════════════════════════════════════════════');
        console.log('🏁 [FIN] Proceso de envío a Airtable completado');
        console.log('═══════════════════════════════════════════════════════════════');
    }
};

// ✅ CAMBIOS EN LAS TRADUCCIONES (10 minutos en lugar de 15)
// En js/languages.js cambiar:
// ESP: info: "40 preguntas • 10 minutos • Resultados inmediatos"
// ENG: info: "40 questions • 10 minutes • Instant results"

// ✅ CAMBIO EN EL FORMULARIO: "aprender español" en lugar de "aprender inglés"
// En la pregunta del formulario:
// "¿Para qué necesitas aprender español?" (en lugar de inglés)

console.log(`✅ Verificación: ${testQuestions.length} preguntas cargadas (1-40)`);
console.log(`✅ Pregunta 10 corregida:`, testQuestions[9].options);
console.log(`✅ Sistema Airtable: Idéntico al código de inglés`);

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Nivel - EspaÃ±ol | Hablandis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.3/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ðŸ”§ EXACTO como inglÃ©s: Script reCAPTCHA v2 con callback -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit"></script>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Aglet+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="font-raleway bg-white">
    <div id="root"></div>

    <!-- ConfiguraciÃ³n de Airtable -->
    <script src="js/config.js"></script>
    <script src="js/languages.js"></script>

    <!-- ðŸ”§ EXACTO como inglÃ©s: Callback global para reCAPTCHA -->
    <script>
        // Variable global para almacenar el widget ID
        window.recaptchaWidgetId = null;
        window.recaptchaReady = false;
        
        // Callback que se ejecuta cuando reCAPTCHA estÃ¡ listo
        window.onRecaptchaLoad = function() {
            console.log('âœ… reCAPTCHA script loaded and ready');
            window.recaptchaReady = true;
            
            // Trigger custom event para notificar a React
            window.dispatchEvent(new CustomEvent('recaptchaReady'));
        };
    </script>

    <script type="text/babel">
        // Iconos SVG
        const icons = {
            ChevronRight: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
            ),
            ChevronLeft: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
            ),
            BookOpen: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            ),
            User: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            ),
            Mail: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            ),
            Phone: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
            ),
            MapPin: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            ),
            CheckCircle: () => (
                <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            )
        };

        const LevelTest = () => {
            const [currentPage, setCurrentPage] = React.useState('start');
            const [answers, setAnswers] = React.useState({});
            const [studentData, setStudentData] = React.useState({
                firstName: '',
                lastName: '',
                email: '',
                city: '',
                howFoundUs: '',
                learningPurpose: '',
                dataProtection: false
            });
            const [submitted, setSubmitted] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [language, setLanguage] = React.useState(getCurrentLanguage());
            
            // ðŸ”§ EXACTO como inglÃ©s: Estado para manejar reCAPTCHA
            const [recaptchaLoaded, setRecaptchaLoaded] = React.useState(false);

            React.useEffect(() => {
                window.updatePageContent = () => {
                    setLanguage(getCurrentLanguage());
                };
                
                return () => {
                    delete window.updatePageContent;
                };
            }, []);

            // ðŸ”§ EXACTO como inglÃ©s: useEffect para manejar reCAPTCHA
            React.useEffect(() => {
                // Listener para cuando reCAPTCHA estÃ© listo
                const handleRecaptchaReady = () => {
                    console.log('âœ… reCAPTCHA ready event received');
                    setRecaptchaLoaded(true);
                };

                // Verificar si ya estÃ¡ listo
                if (window.recaptchaReady) {
                    setRecaptchaLoaded(true);
                } else {
                    window.addEventListener('recaptchaReady', handleRecaptchaReady);
                }

                return () => {
                    window.removeEventListener('recaptchaReady', handleRecaptchaReady);
                };
            }, []);

            // ðŸ”§ EXACTO como inglÃ©s: useEffect para renderizar widget cuando llegamos al formulario
            React.useEffect(() => {
                if (currentPage === 'studentForm' && recaptchaLoaded && !window.recaptchaWidgetId) {
                    // Esperamos un poco para que el DOM estÃ© listo
                    setTimeout(() => {
                        const recaptchaContainer = document.getElementById('recaptcha-container');
                        if (recaptchaContainer && typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                            try {
                                console.log('ðŸ”„ Renderizando widget reCAPTCHA...');
                                window.recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
                                    'sitekey': '6LdSA3orAAAAAM8tvQxUOqdHOfSp_dWZakH7uXnx',
                                    'callback': function(response) {
                                        console.log('âœ… reCAPTCHA completado:', response.substring(0, 50) + '...');
                                    },
                                    'expired-callback': function() {
                                        console.log('âš ï¸ reCAPTCHA expirado');
                                    }
                                });
                                console.log('âœ… Widget reCAPTCHA renderizado con ID:', window.recaptchaWidgetId);
                            } catch (error) {
                                console.error('âŒ Error renderizando reCAPTCHA:', error);
                            }
                        }
                    }, 100);
                }
            }, [currentPage, recaptchaLoaded]);

            const LanguageSelector = () => (
                <div className="language-selector">
                    <button 
                        className={`lang-btn ${language === 'ESP' ? 'active' : ''}`}
                        data-lang="ESP"
                    >
                        ESP
                    </button>
                    <button 
                        className={`lang-btn ${language === 'ENG' ? 'active' : ''}`}
                        data-lang="ENG"
                    >
                        ENG
                    </button>
                </div>
            );

            // PREGUNTAS EN ESPAÃ‘OL (40 preguntas del test espaÃ±ol)
            const testQuestions = [
                { id: 1, question: "Hola, Â¿de dÃ³nde _____ vosotros?", options: ["eres", "soys", "sois", "soy"], correct: 2 },
                { id: 2, question: "La escuela _____ muy bonita y _____ en la playa.", options: ["estÃ¡ -- es", "es -- estÃ¡", "es - es", "estÃ¡ -- estÃ¡"], correct: 1 },
                { id: 3, question: "Â¿DÃ³nde _____? -Yo _____ en MÃ¡laga.", options: ["vives -- vivo", "vivÃ­s - vivimos", "trabajo -- trabajas", "comemos -- comes"], correct: 0 },
                { id: 4, question: "Â¿_____ puedo comprar un buen vino? -En _____ tienda cerca de la escuela.", options: ["CuÃ¡ndo -- su", "Por quÃ© -- mi", "CÃ³mo -- una", "DÃ³nde -- la"], correct: 3 },
                { id: 5, question: "En AndalucÃ­a, (ella) _____ _____ siempre las gafas de sol.", options: ["se desayuna", "se pone", "se lava", "os preparamos"], correct: 1 },
                { id: 6, question: "Â¿_____ profesores dan clase hoy?", options: ["Quienes", "QuÃ©", "Que", "QuiÃ©n"], correct: 1 },
                { id: 7, question: "_____ casa es _____ casa.", options: ["Mi -- nuestras", "Su - sus", "Vuestra -- tus", "Mi -- tu"], correct: 3 },
                { id: 8, question: "Vienes a una escuela _____ bonita en la que se trabaja _____ y _____ bien.", options: ["muy - mucho - mucho", "mucha - muy - muy", "muy - mucho - muy", "muy - mucho -- mucha"], correct: 2 },
                { id: 9, question: "A mÃ­ _____ _____ mucho ir en bicicleta, pero a mi compaÃ±ero no _____ _____ nada.", options: ["nos gustan - le gusta", "les gusta - te gusta", "me gusta - le gusta", "me gustan - les gustan"], correct: 2 },
                { id: 10, question: "Esta escuela es la mejor. Me gusta mucho. _____ _____ recomiendo.", options: ["Te -- la", "La -- los", "Le -- lo", "Me -- les"], correct: 0 },
                { id: 11, question: "En la clase siempre me _____ cerca de la profesora.", options: ["duermo", "acuesto", "siento", "desayuno"], correct: 2 },
                { id: 12, question: "Mi padre mide 2 metros. Es el _____ _____ de sus hermanos.", options: ["mayor", "mÃ¡s alto", "altÃ­simo", "muy alto"], correct: 1 },
                { id: 13, question: "Son las diez y dos minutos de la maÃ±ana. La primera clase _____ _____ empezar ahora mismo.", options: ["termina - de", "debe", "vuelve - a", "acaba -- de"], correct: 3 },
                { id: 14, question: "Mi espaÃ±ol _____ antes muy bÃ¡sico, pero ahora puedo comunicarme mucho mejor.", options: ["fue", "era", "estuvo", "estaba"], correct: 1 },
                { id: 15, question: "Â¿_____ ayer a la excursiÃ³n a Granada?", options: ["Fuiste", "Estuviste", "Eras", "Estabas"], correct: 0 },
                { id: 16, question: "He venido a esta escuela _____ mejorar mi espaÃ±ol.", options: ["por", "al", "para", "asÃ­ puedo"], correct: 2 },
                { id: 17, question: "No me apetece seguir leyendo la revista. _____ tÃº.", options: ["ResÃ©rvala", "LÃ­mpiala", "CÃ³mprala", "LÃ©ela"], correct: 3 },
                { id: 18, question: "Anoche _____ sangrÃ­a en la playa y esta maÃ±ana nos _____ _____ tarde.", options: ["nos gustaba - hemos escuchado", "comimos - te gusta", "bebimos - hemos levantado", "me gustan - les gustan"], correct: 2 },
                { id: 19, question: "No sÃ© quÃ© edad tiene. _____ tener sobre cuarenta aÃ±os.", options: ["Quiere", "Acaba de", "Empieza a", "Debe"], correct: 3 },
                { id: 20, question: "SeÃ±ora, _____ que le ayude.", options: ["dÃ©jame", "permÃ­teme", "permÃ­tame", "quieres"], correct: 2 },
                { id: 21, question: "Â¿De verdad? -Te lo _____. _____ caso.", options: ["promeso / Tenme", "juro / Hazme", "aseguro / Dame", "garantizo / ConcÃ©deme"], correct: 1 },
                { id: 22, question: "Me parece que Emilia no _____ interÃ©s por visitar la feria maÃ±ana.", options: ["tiene", "tenga", "tuve", "tengo"], correct: 0 },
                { id: 23, question: "No creo que _____ problemas en pasarse por aquÃ­ despuÃ©s.", options: ["tengo", "tenga", "tendrÃ¡", "teniera"], correct: 1 },
                { id: 24, question: "La gran _____ estÃ¡ de acuerdo en hacer la fiesta el viernes por la noche.", options: ["mayoridad", "minorÃ­a", "mayorÃ­a", "totalidad"], correct: 2 },
                { id: 25, question: "No me _____ bien de lo que _____ despuÃ©s.", options: ["acuerdo / pasando", "recuerdo / pasÃ³", "acuerdo / pasÃ³", "recuerdo / pasaba"], correct: 2 },
                { id: 26, question: "Espero que te _____ mejor cuando por fin te _____. Hoy has caminado mucho y te mereces un buen descanso.", options: ["sientes / sientas", "sientas / sientas", "sientes / sientes", "sientas / sientes"], correct: 3 },
                { id: 27, question: "Cuando estaba _____ a casa, _____ el atardecer tras las montaÃ±as.", options: ["moviendo / miraba", "avanzando / vi", "yendo / vi", "marchando / veÃ­"], correct: 2 },
                { id: 28, question: "Este fin de semana queremos _____ con Pepe y Sara.", options: ["encontrar", "ver", "quedar", "marchar"], correct: 2 },
                { id: 29, question: "!_____! Â¡Te he dicho que te sientes!", options: ["SiÃ©ntese", "SiÃ©ntense", "SiÃ©ntate", "Sentaos"], correct: 2 },
                { id: 30, question: "_____ _____ gustado conocer Frigiliana. Pero en sÃ³lo dos dÃ­as por MÃ¡laga, Â¡no _____ tiempo de visitarla! La prÃ³xima vez _____.", options: ["Nos hubiera / tendrÃ­amos / iremos", "Nos habrÃ­a / tuvimos / iremos", "Nos hubiese / tendremos / vamos", "Nos fuera / hemos tenido / irÃ­amos"], correct: 1 },
                { id: 31, question: "No sabÃ­amos que ya _____ a la cama. Si lo _____ _____, no habrÃ­amos hecho tanto ruido.", options: ["se habÃ­ais / fuÃ©ramos sabido", "te ibas / hemos sabido", "os habÃ­ais ido / hubiÃ©ramos sabido", "habÃ­a"], correct: 2 },
                { id: 32, question: "OjalÃ¡ que no _____ _____ con nosotros. Cada vez que _____ hay problemas.", options: ["se vaya / vino", "se venga / fue", "se venga / viene", "se vaya / va"], correct: 2 },
                { id: 33, question: "Si te _____ un trabajo como ese, yo que tÃº no me lo _____. Â¡Es una suerte increÃ­ble!", options: ["ofrecÃ­an / pensÃ©", "ofrecen / pensaba", "ofrecieran / pensarÃ©", "hubieran ofrecido / pensabas"], correct: 1 },
                { id: 34, question: "En la entrevista se reprodujeron al pie de la letra las palabras del entrevistado.", options: ["las palabras se reprodujeron a pie de pÃ¡gina", "las palabras se reprodujeron sin exactitud", "las palabras se reprodujeron literalmente", "las palabras se reprodujeron en letras grandes"], correct: 2 },
                { id: 35, question: "En cuanto _____ a quÃ© hora es el concierto, _____ de casa.", options: ["sabemos / salimos", "supimos / salÃ­amos", "sepamos / saldremos", "sabremos / saldrÃ­amos"], correct: 2 },
                { id: 36, question: "Hizo la actividad _____ le dijo el profesor que la hiciera.", options: ["tal como", "igual como", "lo mismo como", "tal y cual"], correct: 0 },
                { id: 37, question: "_____ y _____ el texto definitivo cuando lo tengas listo.", options: ["PiÃ©nselo / dime", "PiÃ©nsatelo / dÃ­game", "PiÃ©nsatelo / dime", "PiÃ©nseselo / dÃ­gamelo"], correct: 2 },
                { id: 38, question: "Siempre que viene tu sobrina se pone a 'dar la lata' al perro.", options: ["animar", "alimentar", "molestar", "jugar con"], correct: 2 },
                { id: 39, question: "Â¿_____ se han apuntado a la excursiÃ³n a Tarifa? Pues no sÃ©, _____ _____ apuntado unos siete alumnos.", options: ["QuiÃ©nes / os hayÃ¡is", "CuÃ¡ntos / se habrÃ¡n", "CuÃ¡les / se hayan", "CÃ³mo / me habrÃ¡n"], correct: 1 },
                { id: 40, question: "Mi hermano _____ es el _____ vendedor que he conocido nunca.", options: ["mejor / meyor", "mayor / major", "mayor / mejor", "major / meyor"], correct: 2 }
            ];

            const handleAnswerSelect = (questionId, answerIndex) => {
                setAnswers({
                    ...answers,
                    [questionId]: answerIndex
                });
            };

            const handleStudentDataChange = (field, value) => {
                setStudentData({
                    ...studentData,
                    [field]: value
                });
            };

            const calculateScore = () => {
                let correct = 0;
                testQuestions.forEach(question => {
                    if (answers[question.id] === question.correct) {
                        correct++;
                    }
                });
                return {
                    correct,
                    total: testQuestions.length,
                    percentage: Math.round((correct / testQuestions.length) * 100)
                };
            };

            const getLevel = (correctAnswers) => {
                if (correctAnswers >= 0 && correctAnswers <= 9) return "A1";
                if (correctAnswers >= 10 && correctAnswers <= 19) return "A2";
                if (correctAnswers >= 20 && correctAnswers <= 29) return "B1";
                if (correctAnswers >= 30 && correctAnswers <= 40) return "B2";
                return "A1";
            };

            // ðŸ”§ EXACTO como inglÃ©s: FUNCIÃ“N submitWithRecaptchaV2
            const submitWithRecaptchaV2 = async () => {
                setLoading(true);
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ðŸš€ [INICIO] Proceso de envÃ­o con reCAPTCHA v2 ESPAÃ‘OL (COPIA EXACTA INGLÃ‰S)');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                try {
                    // PASO 1: VerificaciÃ³n robusta de reCAPTCHA
                    console.log('ðŸ” [PASO 1] Verificando reCAPTCHA v2...');
                    
                    // Verificar que reCAPTCHA estÃ¡ disponible
                    if (typeof grecaptcha === 'undefined') {
                        alert('âŒ reCAPTCHA no estÃ¡ cargado. Recarga la pÃ¡gina.');
                        setLoading(false);
                        return;
                    }
                    
                    // Verificar que tenemos un widget renderizado
                    if (window.recaptchaWidgetId === null) {
                        alert('âŒ Widget reCAPTCHA no estÃ¡ inicializado. Recarga la pÃ¡gina.');
                        setLoading(false);
                        return;
                    }

                    // Obtener respuesta del widget especÃ­fico
                    let recaptchaResponse;
                    try {
                        recaptchaResponse = grecaptcha.getResponse(window.recaptchaWidgetId);
                        console.log('ðŸ” [DEBUG] Token completo:', recaptchaResponse);
                        console.log('ðŸ” [DEBUG] Longitud token:', recaptchaResponse ? recaptchaResponse.length : 'NULL');
                        console.log('ðŸ” [DEBUG] Widget ID usado:', window.recaptchaWidgetId);
                        console.log('ðŸ” [DEBUG] Timestamp:', new Date().toISOString());
                        console.log('âœ… [PASO 1] Respuesta obtenida del widget ID:', window.recaptchaWidgetId);
                    } catch (error) {
                        console.error('âŒ [ERROR] Error obteniendo respuesta reCAPTCHA:', error);
                        alert('âŒ Error: El widget reCAPTCHA no responde. Recarga la pÃ¡gina.');
                        setLoading(false);
                        return;
                    }
                    
                    if (!recaptchaResponse || recaptchaResponse.trim() === '') {
                        console.log('âŒ [ERROR] Token reCAPTCHA vacÃ­o o null');
                        alert('âŒ Por favor, marca la casilla "No soy un robot" antes de continuar.');
                        grecaptcha.reset(window.recaptchaWidgetId);
                        setLoading(false);
                        return;
                    }
                    
                    console.log('âœ… [PASO 1] reCAPTCHA v2 completado exitosamente');
                    
                    // PASO 2: Calcular resultados
                    console.log('ðŸ“Š [PASO 2] Calculando puntuaciÃ³n...');
                    const score = calculateScore();
                    const level = getLevel(score.correct);
                    console.log('âœ… [PASO 2] PuntuaciÃ³n calculada:', score);
                    console.log('âœ… [PASO 2] Nivel determinado:', level);
                    
                    // PASO 3: Preparar datos completos
                    console.log('ðŸ“¦ [PASO 3] Preparando datos para envÃ­o...');
                    
                    // Crear objeto con respuestas detalladas
                    const detailedAnswers = {};
                    testQuestions.forEach(question => {
                        if (answers[question.id] !== undefined) {
                            detailedAnswers[`Pregunta ${question.id}: ${question.question}`] = 
                                question.options[answers[question.id]];
                        }
                    });
                    
                    const dataToSend = {
                        // ðŸ‘¤ Datos del estudiante
                        firstName: studentData.firstName,
                        lastName: studentData.lastName,
                        email: studentData.email,
                        city: studentData.city || "",
                        howFoundUs: studentData.howFoundUs || "",
                        learningPurpose: studentData.learningPurpose || "",
                        
                        // ðŸ“Š Resultados del test
                        score: score.correct,
                        total: score.total,
                        percentage: score.percentage,
                        level: level,
                        
                        // ðŸ” Datos adicionales PARA ESPAÃ‘OL
                        testType: "Test de nivel espaÃ±ol",
                        language: "EspaÃ±ol",
                        detailedAnswers: JSON.stringify(detailedAnswers, null, 2),
                        
                        // ðŸ” Token reCAPTCHA
                        recaptchaToken: recaptchaResponse
                    };
                    
                    console.log('âœ… [PASO 3] Datos preparados correctamente');
                    
                    // PASO 4: Enviar a funciÃ³n Netlify
                    console.log('ðŸŒ [PASO 4] Enviando a funciÃ³n Netlify ESPAÃ‘OL...');
                    const netlifyUrl = '/.netlify/functions/verify-and-save';
                    
                    const response = await fetch(netlifyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend)
                    });
                    
                    console.log('ðŸ“¥ [PASO 4] Response recibido:', response.status, response.statusText);
                    
                    // PASO 5: Procesar respuesta
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('âœ… [Ã‰XITO] Â¡Datos guardados exitosamente!', responseData);
                        
                        // Resetear reCAPTCHA para prÃ³ximo uso
                        try {
                            grecaptcha.reset(window.recaptchaWidgetId);
                            console.log('âœ… reCAPTCHA reseteado exitosamente');
                        } catch (resetError) {
                            console.log('âš ï¸ Warning al resetear reCAPTCHA:', resetError.message);
                        }
                        
                        // Ir a resultados
                        setSubmitted(true);
                        setCurrentPage('results');
                        
                        console.log('ðŸŽ‰ [Ã‰XITO] Proceso completado - usuario redirigido a resultados');
                        
                    } else {
                        const responseText = await response.text();
                        console.log('âŒ [ERROR] Response no OK:', responseText);
                        
                        try {
                            const errorData = JSON.parse(responseText);
                            alert(`âŒ Error: ${errorData.error}\n\nRevisa la consola para mÃ¡s detalles.`);
                        } catch (parseError) {
                            alert(`âŒ Error del servidor (Status: ${response.status})\nRevisa la consola para mÃ¡s detalles.`);
                        }
                        
                        // Resetear reCAPTCHA para reintentar
                        try {
                            grecaptcha.reset(window.recaptchaWidgetId);
                        } catch (resetError) {
                            console.log('âš ï¸ Warning al resetear reCAPTCHA:', resetError.message);
                        }
                    }
                    
                } catch (error) {
                    console.log('ðŸ’¥ [ERROR CRÃTICO]:', error);
                    alert(`ðŸ’¥ Error crÃ­tico: ${error.message}\n\nRevisa la consola para mÃ¡s detalles.`);
                    
                    // Resetear reCAPTCHA en caso de error
                    try {
                        if (window.recaptchaWidgetId !== null) {
                            grecaptcha.reset(window.recaptchaWidgetId);
                        }
                    } catch (resetError) {
                        console.log('âŒ Error al resetear reCAPTCHA:', resetError.message);
                    }
                    
                } finally {
                    console.log('ðŸ [FINAL] Finalizando proceso...');
                    setLoading(false);
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                }
            };

            const nextQuestion = () => {
                const currentQuestionIndex = testQuestions.findIndex(q => q.id.toString() === currentPage);
                if (currentQuestionIndex < testQuestions.length - 1) {
                    setCurrentPage((currentQuestionIndex + 2).toString());
                } else {
                    setCurrentPage('studentForm');
                }
            };

            const prevQuestion = () => {
                const currentQuestionIndex = testQuestions.findIndex(q => q.id.toString() === currentPage);
                if (currentQuestionIndex > 0) {
                    setCurrentPage((currentQuestionIndex).toString());
                } else {
                    setCurrentPage('start');
                }
            };

            // PÃ¡gina de inicio
            if (currentPage === 'start') {
                return (
                    <div className="min-h-screen bg-playa-purple-light flex items-center justify-center p-4 pt-8">
                        <div className="bg-white rounded-3xl shadow-lg p-10 max-w-2xl w-full text-center border border-gray-100">
                            <div className="mb-8">
                                <LanguageSelector />
                                
                                <div className="mx-auto mb-6 flex justify-center">
                                    <img 
                                        src="images/hablandis.svg" 
                                        alt="Hablandis Logo" 
                                        className="h-24 w-auto"
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                            e.target.nextElementSibling.style.display = 'flex';
                                        }}
                                    />
                                    <div className="text-playa-purple text-5xl hidden justify-center items-center">
                                        <icons.BookOpen />
                                    </div>
                                </div>
                                <h1 className="font-aglet text-4xl font-bold text-black mb-6">
                                    {t('startPage.title')}
                                </h1>
                                <p className="text-lg text-black mb-6 font-raleway">
                                    {t('startPage.subtitle')}
                                </p>
                                <div className="bg-playa-purple-light rounded-xl p-6 mb-6 border border-playa-purple">
                                    <p className="font-raleway font-medium text-black">
                                        ðŸ“‹ {t('startPage.info')}
                                    </p>
                                </div>
                            </div>
                            
                            <button
                                onClick={() => setCurrentPage('1')}
                                className="btn-primary flex items-center mx-auto gap-3 font-aglet"
                            >
                                {t('startPage.startButton')}
                                <icons.ChevronRight />
                            </button>
                        </div>
                    </div>
                );
            }

            // PÃ¡ginas de preguntas
            const questionPage = testQuestions.find(q => q.id.toString() === currentPage);
            if (questionPage) {
                const progress = (questionPage.id / testQuestions.length) * 100;
                
                return (
                    <div className="min-h-screen bg-playa-purple-light p-4 pt-8">
                        <div className="max-w-4xl mx-auto">
                            {/* Header solo con logo */}
                            <div className="text-center mb-8 bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                <img 
                                    src="images/hablandis.svg" 
                                    alt="Hablandis Logo" 
                                    className="h-12 w-auto mx-auto"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                    }}
                                />
                            </div>

                            {/* Barra de progreso */}
                            <div className="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-100">
                                <div className="flex justify-between items-center mb-3">
                                    <span className="font-aglet text-sm font-medium text-black">
                                        {t('progress.question')} {questionPage.id} {t('progress.of')} {testQuestions.length}
                                    </span>
                                    <span className="font-aglet text-sm font-medium text-playa-purple">
                                        {Math.round(progress)}% {t('progress.completed')}
                                    </span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-3">
                                    <div 
                                        className="bg-playa-purple h-3 rounded-full transition-all duration-300"
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                            </div>

                            {/* Pregunta */}
                            <div className="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                                <h2 className="font-aglet text-2xl font-bold text-black mb-8">
                                    {questionPage.question}
                                </h2>
                                
                                <div className="space-y-3 mb-8">
                                    {questionPage.options.map((option, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handleAnswerSelect(questionPage.id, index)}
                                            className={`w-full p-5 text-left rounded-lg border-2 transition-all duration-200 font-raleway text-lg ${
                                                answers[questionPage.id] === index
                                                    ? 'border-playa-purple bg-playa-purple-light text-black'
                                                    : 'border-gray-200 hover:border-playa-purple hover:bg-playa-purple-light text-black'
                                            }`}
                                        >
                                            <div className="flex items-center">
                                                <span className={`w-7 h-7 rounded-full border-2 mr-4 flex items-center justify-center font-aglet font-bold text-sm ${
                                                    answers[questionPage.id] === index
                                                        ? 'border-playa-purple bg-playa-purple text-white'
                                                        : 'border-gray-300 text-gray-500'
                                                }`}>
                                                    {String.fromCharCode(65 + index)}
                                                </span>
                                                <span className="text-black">{option}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>

                                {/* NavegaciÃ³n */}
                                <div className="flex justify-between">
                                    <button
                                        onClick={prevQuestion}
                                        className="flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-all duration-200 font-aglet"
                                    >
                                        <icons.ChevronLeft />
                                        {t('navigation.previous')}
                                    </button>
                                    
                                    <button
                                        onClick={nextQuestion}
                                        disabled={answers[questionPage.id] === undefined}
                                        className={`flex items-center gap-2 px-6 py-3 rounded-lg transition-all duration-200 font-aglet ${
                                            answers[questionPage.id] !== undefined
                                                ? 'bg-playa-purple hover:bg-playa-navy text-white'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {questionPage.id === testQuestions.length ? t('navigation.finish') : t('navigation.next')}
                                        <icons.ChevronRight />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Formulario de datos del estudiante
            if (currentPage === 'studentForm') {
                return (
                    <div className="min-h-screen bg-playa-yellow-light p-4 pt-8">
                        <div className="max-w-2xl mx-auto">
                            {/* Header solo con logo */}
                            <div className="text-center mb-6 bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                <img 
                                    src="images/hablandis.svg" 
                                    alt="Hablandis Logo" 
                                    className="h-10 w-auto mx-auto"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                    }}
                                />
                            </div>

                            <div className="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                                <div className="text-center mb-8">
                                    <div className="mx-auto text-playa-yellow mb-4 flex justify-center text-4xl">
                                        <icons.User />
                                    </div>
                                    <h2 className="font-aglet text-3xl font-bold text-black mb-2">
                                        {t('studentForm.title')}
                                    </h2>
                                    <p className="text-black font-raleway">
                                        {t('studentForm.subtitle')}
                                    </p>
                                </div>

                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                                {t('studentForm.fields.firstName.label')}
                                            </label>
                                            <input
                                                type="text"
                                                value={studentData.firstName}
                                                onChange={(e) => handleStudentDataChange('firstName', e.target.value)}
                                                className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                                placeholder={t('studentForm.fields.firstName.placeholder')}
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                                {t('studentForm.fields.lastName.label')}
                                            </label>
                                            <input
                                                type="text"
                                                value={studentData.lastName}
                                                onChange={(e) => handleStudentDataChange('lastName', e.target.value)}
                                                className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                                placeholder={t('studentForm.fields.lastName.placeholder')}
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                            {t('studentForm.fields.email.label')}
                                        </label>
                                        <input
                                            type="email"
                                            value={studentData.email}
                                            onChange={(e) => handleStudentDataChange('email', e.target.value)}
                                            className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                            placeholder={t('studentForm.fields.email.placeholder')}
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                            {t('studentForm.fields.city.label')}
                                        </label>
                                        <input
                                            type="text"
                                            value={studentData.city}
                                            onChange={(e) => handleStudentDataChange('city', e.target.value)}
                                            className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                            placeholder={t('studentForm.fields.city.placeholder')}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                            {t('studentForm.fields.howFoundUs.label')}
                                        </label>
                                        <select
                                            value={studentData.howFoundUs}
                                            onChange={(e) => handleStudentDataChange('howFoundUs', e.target.value)}
                                            className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                        >
                                            <option value="">{t('studentForm.fields.howFoundUs.options.placeholder')}</option>
                                            <option value="busqueda-navegador">{t('studentForm.fields.howFoundUs.options.browser')}</option>
                                            <option value="redes-sociales">{t('studentForm.fields.howFoundUs.options.social')}</option>
                                            <option value="amigos">{t('studentForm.fields.howFoundUs.options.friends')}</option>
                                            <option value="anuncios">{t('studentForm.fields.howFoundUs.options.ads')}</option>
                                            <option value="otra">{t('studentForm.fields.howFoundUs.options.other')}</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-black mb-2 font-aglet">
                                            {t('studentForm.fields.purpose.label')}
                                        </label>
                                        <select
                                            value={studentData.learningPurpose}
                                            onChange={(e) => handleStudentDataChange('learningPurpose', e.target.value)}
                                            className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-playa-purple focus:border-playa-purple font-raleway text-black"
                                        >
                                            <option value="">{t('studentForm.fields.purpose.options.placeholder')}</option>
                                            <option value="trabajo">{t('studentForm.fields.purpose.options.work')}</option>
                                            <option value="estudios">{t('studentForm.fields.purpose.options.studies')}</option>
                                            <option value="negocios">{t('studentForm.fields.purpose.options.business')}</option>
                                            <option value="cultura">{t('studentForm.fields.purpose.options.culture')}</option>
                                        </select>
                                    </div>

                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <div className="flex items-start gap-3">
                                            <input
                                                type="checkbox"
                                                id="dataProtection"
                                                checked={studentData.dataProtection}
                                                onChange={(e) => handleStudentDataChange('dataProtection', e.target.checked)}
                                                className="mt-1 w-4 h-4 text-playa-purple bg-gray-100 border-gray-300 rounded focus:ring-playa-purple"
                                                required
                                            />
                                            <label htmlFor="dataProtection" className="text-xs text-gray-700 font-raleway leading-relaxed">
                                                <span className="font-semibold">{t('studentForm.dataProtection.title')}</span> {t('studentForm.dataProtection.text')}
                                            </label>
                                        </div>
                                    </div>

                                    {/* ðŸ”§ EXACTO como inglÃ©s: WIDGET RECAPTCHA */}
                                    <div className="flex justify-center mb-6">
                                        <div id="recaptcha-container" className="min-h-[78px] flex items-center justify-center">
                                            {!recaptchaLoaded && (
                                                <div className="text-gray-500 font-raleway">
                                                    Cargando verificaciÃ³n...
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={() => setCurrentPage(testQuestions.length.toString())}
                                        className="flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-all duration-200 font-aglet"
                                    >
                                        <icons.ChevronLeft />
                                        {t('studentForm.buttons.back')}
                                    </button>
                                    
                                    <button
                                        onClick={submitWithRecaptchaV2}
                                        disabled={!studentData.firstName || !studentData.lastName || !studentData.email || !studentData.dataProtection || loading || !recaptchaLoaded}
                                        className={`flex items-center gap-2 px-8 py-3 rounded-lg transition-all duration-200 font-aglet ${
                                            studentData.firstName && studentData.lastName && studentData.email && studentData.dataProtection && !loading && recaptchaLoaded
                                                ? 'bg-playa-purple hover:bg-playa-teal text-white'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {loading ? (
                                            <>
                                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                {t('studentForm.buttons.sending')}
                                            </>
                                        ) : (
                                            <>
                                                <icons.CheckCircle />
                                                {t('studentForm.buttons.submit')}
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // PÃ¡gina de resultados
            if (currentPage === 'results') {
                const score = calculateScore();
                const level = getLevel(score.correct);
                
                return (
                    <div className="min-h-screen bg-playa-purple-light p-4 pt-8">
                        <div className="max-w-2xl mx-auto">
                            {/* Header solo con logo */}
                            <div className="text-center mb-6 bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                <img 
                                    src="images/hablandis.svg" 
                                    alt="Hablandis Logo" 
                                    className="h-10 w-auto mx-auto"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                    }}
                                />
                            </div>

                            <div className="bg-white rounded-xl shadow-sm p-8 text-center border border-gray-100">
                                <div className="mx-auto text-playa-green mb-6 flex justify-center text-5xl">
                                    <icons.CheckCircle />
                                </div>
                                
                                <h2 className="font-aglet text-3xl font-bold text-black mb-6">
                                    {t('results.title')}
                                </h2>
                                
                                <div className="bg-playa-purple text-white rounded-xl p-8 mb-6">
                                    <h3 className="font-aglet text-2xl font-bold mb-4">
                                        {t('results.yourLevel')} {t(`results.levels.${level}`)}
                                    </h3>
                                    <p className="font-raleway text-lg">
                                        {score.correct} {t('progress.of')} {score.total} {t('results.score')}
                                    </p>
                                    <p className="font-raleway text-base opacity-90">
                                        ({score.percentage}% {t('results.percentage')})
                                    </p>
                                </div>

                                <div className="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
                                    <h4 className="font-aglet font-bold text-black mb-4 text-lg">{t('results.savedData')}</h4>
                                    <div className="text-left space-y-2 text-black font-raleway">
                                        <p><strong>{t('results.fields.name')}</strong> {studentData.firstName} {studentData.lastName}</p>
                                        <p><strong>{t('results.fields.email')}</strong> {studentData.email}</p>
                                        {studentData.city && <p><strong>{t('results.fields.city')}</strong> {studentData.city}</p>}
                                        {studentData.howFoundUs && <p><strong>{t('results.fields.howFoundUs')}</strong> {studentData.howFoundUs}</p>}
                                        {studentData.learningPurpose && <p><strong>{t('results.fields.purpose')}</strong> {studentData.learningPurpose}</p>}
                                    </div>
                                </div>

                                <p className="text-black mb-8 font-raleway">
                                    {t('results.successMessage')}
                                </p>

                                <button
                                    onClick={() => {
                                        setCurrentPage('start');
                                        setAnswers({});
                                        setStudentData({ 
                                            firstName: '', lastName: '', email: '', city: '',
                                            howFoundUs: '', learningPurpose: '', dataProtection: false
                                        });
                                        setSubmitted(false);
                                        // Reset reCAPTCHA state
                                        window.recaptchaWidgetId = null;
                                    }}
                                    className="bg-playa-purple hover:bg-playa-navy text-white font-bold py-4 px-8 rounded-lg transition-all duration-200 font-aglet"
                                >
                                    {t('results.newTestButton')}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        ReactDOM.render(<LevelTest />, document.getElementById('root'));
    </script>
</body>
</html>
